<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            min-width: 250px;
        }

        * {
            box-sizing: border-box;
        }

        ul {
            margin: 0;
            padding: 0;
        }

        ul li {
            cursor: pointer;
            position: relative;
            padding: 12px 8px 12px 40px;
            list-style-type: none;
            background: #eee;
            font-size: 18px;
            transition: 0.2s;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        ul li:nth-child(odd) {
            background: #f9f9f9;
        }

        ul li:hover {
            background: #ddd;
        }

        ul li.checked {
            background: #00c000;
            color: #fff;
            text-decoration: line-through;
        }

        ul li.checked::before {
            content: '';
            position: absolute;
            border-color: #fff;
            border-style: solid;
            border-width: 0 2px 2px 0;
            top: 10px;
            left: 16px;
            transform: rotate(45deg);
            height: 15px;
            width: 7px;
        }

        .close {
            position: absolute;
            right: 0;
            top: 0;
            padding: 12px 16px 12px 16px;
        }

        .close:hover {
            background-color: #2b2d30;
            color: white;
        }

        .header {
            background-color: #313c4c;
            padding: 30px 40px;
            color: white;
            text-align: center;
        }

        .header:after {
            content: "";
            display: table;
            clear: both;
        }

        input {
            margin: 0;
            border: none;
            border-radius: 0;
            width: 65%;
            padding: 10px;
            float: left;
            font-size: 16px;
        }

        .addBtn, .loadBtn {
            padding: 10px;
            width: 17.5%;
            background: #d9d9d9;
            color: #555;
            float: left;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 0;
        }

        .addBtn:hover, .loadBtn:hover {
            background-color: #bbb;
        }

        /* Новый стиль для черной жирной рамки */
        .container {
            border: 20px solid rgba(41, 41, 41, 0.87);
            border-radius: 15px;
            padding: 0px;
            width: 90%;
            margin: 20px auto;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>

<body>
<div class="container">
    <div id="myDIV" class="header">
        <h2 style="margin:5px">Список задач</h2>
        <input type="text" id="myInput" placeholder="" onkeypress="handleKeyPress(event)">
        <span onclick="newElement()" class="addBtn">Добавить</span>
        <span onclick="loadTodos()" class="loadBtn">Обновить</span>
    </div>

    <ul id="myUL"></ul>
</div>
<script>
    const apiUrl = 'http://localhost:8080/axelor-erp/ws/rest/com.axelor.apps.pbproject.db.DailyTask';

    function getCookies() {
        return decodeURIComponent(document.cookie)
            .split('; ')
            .reduce((acc, cur) => {
                const [k, v] = cur.split('=');
                return {...acc, [k]: v};
            }, {});
    }

    // Обработчик для клавиши Enter
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            newElement();
        }
    }

    // Загрузка задач с сервера
    function loadTodos() {
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const ul = document.getElementById('myUL');
                ul.innerHTML = ''; // Очищаем список

                // Сортируем задачи по полю "taskOrder"
                data.data.sort((a, b) => a.taskOrder - b.taskOrder).forEach(todo => {
                    const li = document.createElement('li');
                    li.textContent = todo.title;
                    li.dataset.id = todo.id;
                    li.dataset.version = todo.version;
                    li.dataset.taskOrder = todo.taskOrder; // Сохраняем порядок

                    if (todo.completedDate) {
                        li.classList.add('checked');
                    }

                    const span = document.createElement("SPAN");
                    const txt = document.createTextNode("\u00D7");
                    span.className = "close";
                    span.appendChild(txt);
                    li.appendChild(span);

                    ul.appendChild(li);

                    // Привязываем событие для удаления задачи
                    span.onclick = function () {
                        deleteTodo(todo.id);
                    };

                    // Привязываем событие для выделения задачи как выполненной
                    li.onclick = function () {
                        toggleComplete(todo.id, li);
                    };
                });

                // Делаем задачи перетаскиваемыми
                const sortable = new Sortable(ul, {
                    animation: 150,
                    onEnd: function () {
                        updateTaskOrder();  // Пересчет порядка задач после перетаскивания
                        rebindTaskEvents();  // Перепривязка событий
                    }
                });
            })
            .catch(error => {
                console.error('Ошибка загрузки задач:', error);
            });
    }

    // Привязка событий для всех задач
    function rebindTaskEvents() {
        const items = document.querySelectorAll('#myUL li');
        items.forEach((li) => {
            const taskId = li.dataset.id;
            li.onclick = function () {
                toggleComplete(taskId, li);
            };
        });
    }



    // Функция выделения задачи как выполненной
    function toggleComplete(id, li) {
        const isCompleted = li.classList.contains('checked');

        // Собираем данные для запроса
        const requestData = {
            data: {
                completedDate: isCompleted ? null : new Date().toISOString(),  // Убираем дату если снимаем выделение
                version: Number(li.dataset.version)  // Отправляем актуальную версию
            }
        };

        // Отправляем запрос на сервер для обновления статуса задачи
        fetch(`${apiUrl}/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCookies()['CSRF-TOKEN']
            },
            body: JSON.stringify(requestData)  // Преобразуем данные в JSON
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 0) {
                    // Если запрос успешен, обновляем состояние задачи на клиенте
                    if (isCompleted) {
                        li.classList.remove('checked');
                    } else {
                        li.classList.add('checked');
                    }
                    li.dataset.version = data.data[0].version;  // Обновляем версию на клиенте
                } else {
                    throw new Error('Ошибка обновления на сервере');
                }
            })
            .catch(error => {
                console.error('Ошибка обновления задачи:', error);
                console.log(`Ошибка при обновлении задачи с ID ${id}. Ответ сервера:`, error);
            });
    }

    function deleteTodo(id) {
        fetch(`${apiUrl}/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCookies()['CSRF-TOKEN']
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети при удалении: ' + response.status);
                }
                loadTodos();
            })
            .catch(error => {
                console.error('Ошибка удаления задачи:', error);
            });
    }

    // Функция для обновления порядка задач на сервере
    function updateTaskOrder() {
        const items = document.querySelectorAll('#myUL li');

        items.forEach((item, index) => {
            const taskId = item.dataset.id;

            // Убедитесь, что версия объекта и порядковый номер обновляются корректно
            fetch(`${apiUrl}/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCookies()['CSRF-TOKEN']
                },
                body: JSON.stringify({
                    data: {
                        taskOrder: index,  // Присваиваем уникальный порядковый индекс
                        version: Number(item.dataset.version)  // Отправляем актуальную версию объекта
                    }
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка обновления очередности задач');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 0) {
                        console.log('Очередность задачи обновлена:', taskId);
                        item.dataset.version = data.data[0].version;  // Обновляем версию на клиенте
                        item.dataset.taskOrder = index;  // Обновляем порядковый номер на клиенте
                    } else {
                        throw new Error('Ошибка обновления на сервере');
                    }
                })
                .catch(error => {
                    console.error('Ошибка обновления задачи:', error);
                    console.log(`Ошибка при обновлении задачи с ID ${taskId}. Ответ сервера:`, error);
                });
        });
    }



    // Добавление новой задачи
    function newElement() {
        const inputValue = document.getElementById("myInput").value;
        if (inputValue === '') {
            alert("You must write something!");
        } else {
            const lastOrder = document.querySelectorAll('#myUL li').length; // Вычисляем текущий последний порядковый номер
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCookies()['CSRF-TOKEN']
                },
                body: JSON.stringify({
                    data: {
                        title: inputValue,
                        responsible: {id: 1},
                        taskOrder: lastOrder // Присваиваем порядковый номер новой задаче
                    }
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети: ' + response.status);
                    }
                    return response.json();
                })
                .then(() => {
                    loadTodos();
                })
                .catch(error => {
                    console.error('Ошибка добавления задачи:', error);
                });

            document.getElementById("myInput").value = "";
        }
    }

    document.addEventListener('DOMContentLoaded', loadTodos);
</script>

</body>
</html>
