<?xml version="1.0" encoding="UTF-8"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views https://axelor.com/xml/ns/object-views/object-views_7.1.xsd">

    <dashboard name="pbp.ratings-by-team-dashboard" title="Ratings by team!">
        <dashlet action="chart:chart-best-team-completed-tasks" width="100%" height="400px"/>
        <dashlet action="chart:chart-best-team-spent-hours" width="100%" height="400px"/>
        <dashlet action="chart:chart-tasks-completed-by-team-project" width="100%" height="400px"  />

    </dashboard>
    <!-- диаграмма показывающая какая команда больше выполнила задач-->
    <chart name="chart-best-team-completed-tasks" title="The best team that completed the most tasks" stacked="true"
           onInit="pbp.rating-update-date">
        <search-fields>
            <field type="datetime" name="fromDateTime" title="From Date"/>
            <field type="datetime" name="toDateTime" title="To Date"/>
        </search-fields>
        <dataset type="sql">
            <![CDATA[
        SELECT t.name AS team_name, COUNT(pt.id) AS total_completed_tasks
        FROM team_team t
        JOIN team_team_members m ON t.id = m.team_set
        JOIN auth_user u ON m.members = u.id
        JOIN project_project_task pt ON pt.assigned_to = u.id
        WHERE pt.status = 3
        GROUP BY t.name
        ORDER BY total_completed_tasks DESC
    ]]>
        </dataset>
        <category key="team_name"/>
        <series key="total_completed_tasks" type="hbar"/>
    </chart>

    <!-- диаграмма показывающая какая команда потратила больше часов-->

    <chart name="chart-best-team-spent-hours" title="Best team that spent the most hours"
           onInit="pbp.rating-update-date">
        <search-fields>
            <field name="fromDateTime" title="From Date" type="datetime"/>
            <field name="toDateTime" title="To Date" type="datetime"/>
        </search-fields>
        <dataset type="sql">
            <![CDATA[
          SELECT t.name AS team_name,
          SUM(pt.spent_time) AS total_hours
          FROM team_team t
          JOIN team_team_members m ON t.id = m.team_set
          JOIN auth_user u ON m.members = u.id
          JOIN project_project_task pt ON pt.assigned_to = u.id
          WHERE pt.task_end_date BETWEEN DATE_TRUNC('month', CURRENT_DATE) AND CURRENT_DATE
          GROUP BY t.name
          ORDER BY total_hours DESC;
        ]]>
        </dataset>
        <category key="team_name"/>
        <series key="total_hours" type="donut"/>
    </chart>

    <!-- диаграмма показывающая сколько задач выполнила каждая команда в проектах-->
    <chart name="chart-tasks-completed-by-team-project" title="How many tasks did the team complete in the project?" stacked="true"
           onInit="pbp.rating-update-date">
        <search-fields>
            <field type="datetime" name="fromDateTime" title="From Date"/>
            <field type="datetime" name="toDateTime" title="To Date"/>
        </search-fields>
        <dataset type="jpql">
            <![CDATA[
        SELECT t.name AS teamName, p.name AS projectName, COUNT(pt.id) AS totalTasks
        FROM ProjectTask pt
        JOIN pt.assignedTo u
        JOIN u.teamSet t
        JOIN pt.project p
        WHERE pt.taskEndDate BETWEEN :fromDateTime AND :toDateTime
        AND pt.status.id = 3
        GROUP BY t.name, p.name
        ORDER BY totalTasks DESC
        ]]>
        </dataset>
        <category key="teamName"/>
        <series key="totalTasks" type="bar" groupBy="projectName"/>
    </chart>

</object-views>
