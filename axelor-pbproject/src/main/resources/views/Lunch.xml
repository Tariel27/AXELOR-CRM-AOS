<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.0.xsd">

    <!--  grid для обеда партнеров -->
    <grid title="Partner lunch" name="pbp.lunch-grid-view" model="com.axelor.apps.pbproject.db.Lunch">
        <field name="partnerName" title="Partner name"/>
        <field name="dishName" title="Lunch"/>
        <field name="portion" title="Portion size"/>
        <field name="dateCreate" title="Order date"/>
        <field name="partnerComment" title="Your comment"/>
    </grid>

    <!--  form для обеда партнеров -->
    <form name="pbp.lunch-form-view" title="Partner lunch" model="com.axelor.apps.pbproject.db.Lunch" width="large"
          onNew="pbp.update-user-and-date-on-partnerName">
        <panel title="Dish menu" itemSpan="12">
            <field name="partnerName" title="Partner name"/>
            <field name="dishName" title="Lunch"/>
            <field name="some" x-type="many-to-one"
                   x-target="com.axelor.apps.pbproject.db.Dish"
                   x-target-name="dishName" hidden="true"/>
            <field name="portion" title="Portion size" widget="SingleSelect"/>
            <field name="dateCreate" title="Order date"/>
            <field name="partnerComment" title="Your comment"/>
        </panel>
        <panel>
            <button name="saveBtn" title="Save" onClick="save"/>
        </panel>

    </form>


    <dashboard name="pbp.lunch-for-partners-dashboard" title="Lunch for partners!">
        <dashlet height="300px" colSpan="3" action="custom:report-user-lunch-stats"/>

        <dashlet height="350px" colSpan="12" action="custom:report-table-lunch-for-users"/>
        <dashlet height="500px" colSpan="12" action="form:pbp.lunch-form-view"/>
        <dashlet height="350px" colSpan="12" action="grid:pbp.lunch-grid-view"/>

    </dashboard>

<!-- таблица показывающая всех партнеров сделавших заказ-->
    <custom name="report-table-lunch-for-users" title="Users information" css="report-box">
        <field name="fullName" title="Name"/>
        <field name="dishName" title="Dish" type="string"/>
        <field name="portion" title="Portion" type="string"/>
        <field name="dateCreate" title="Date of create" type="date"/>
        <field name="partnerComment" title="Comment" type="string"/>

        <dataset type="jpql">
            <![CDATA[
        SELECT u.fullName AS fullName,
               d.name AS dishName,
               l.portion AS portion,
               l.dateCreate AS dateCreate,
               l.partnerComment AS partnerComment
        FROM User u
        LEFT JOIN Lunch l ON u.id = l.partnerName.id
        LEFT JOIN l.dishName d
        WHERE l.dateCreate >= CURRENT_DATE OR l.dateCreate IS NULL
        ORDER BY u.fullName
        ]]>
        </dataset>

        <template><![CDATA[
    <report-table columns='fullName,dishName,portion,dateCreate,partnerComment'/>
    ]]></template>
    </custom>

<!--    report-box-->

    <custom name="custom:report-user-lunch-stats" title="" css="report-box">
        <dataset type="rpc"><![CDATA[com.axelor.apps.pbproject.web.LunchController:reportLunch]]></dataset>
        <template><![CDATA[
  <div class="report-data">
    <h1>{{first.total}}</h1>
    <small>Total users</small>
    <div class="report-tags" style="display: flex; align-items: center;">
      <i class="fa fa-user-circle" style="margin-right: 5px;"></i>
      <span class="label label-success">Total users</span>
    </div>
  </div>

]]></template>
    </custom>




</object-views>