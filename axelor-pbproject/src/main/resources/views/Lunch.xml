<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.0.xsd">



    <!--  grid для обеда партнеров -->
    <grid title="Partner lunch" name="pbp.lunch-grid-view" model="com.axelor.apps.pbproject.db.Lunch">
        <field name="partnerName" title="Partner name"/>
        <field name="dishName" title="Lunch"/>
        <field name="portion" title="Portion size"/>
        <field name="dateCreate" title="Order date"/>
        <field name="partnerComment" title="Your comment"/>
    </grid>

    <!--  form для обеда партнеров -->
    <form name="pbp.lunch-form-view" title="Partner lunch" model="com.axelor.apps.pbproject.db.Lunch" width="large"
          onNew="pbp.update-user-and-date-on-partnerName-for-lunch" >
        <panel name="help" colSpan="12" hideIf="isOrderLunch">
        <help>
            <![CDATA[

Orders are accepted until 19:00!
]]>
        </help>
        </panel>

        <panel title="Dish menu" itemSpan="12" hideIf="isOrderLunch">
            <field name="partnerName" title="Partner name" hidden="true"/>
            <field name="dishName" title="Lunch" onChange="pbp.searchDishOnDuckDuckGo"/>
            <field name="some" x-type="many-to-one"
                   x-target="com.axelor.apps.pbproject.db.Dish"
                   x-target-name="dishName" hidden="true"/>
            <field name="portion" title="Portion size" widget="SingleSelect"/>
            <field name="dateCreate" title="Order date" hidden="true"/>
            <field name="partnerComment" title="Your comment"/>
            <field name="isOrderLunch" title="is order lunch" readonly="true" hidden="true"/>

        </panel>
        <panel hideIf="isOrderLunch">
            <button name="saveBtn" title="Save" onClick="pbp.update-field-isShow-true,save" css="btn-success"
                    icon="fa-check-square-o" colSpan="6"/>
            <field name="addUrlForGoogle" widget="url" colSpan="6"/>

        </panel>

    </form>


    <dashboard name="pbp.lunch-for-partners-dashboard" title="Lunch for partners!">

        <dashlet height="300px" colSpan="3" action="custom:report-user-lunch-stats"/>
        <dashlet height="300px" colSpan="3" action="custom:report-user-portion-stats"/>
        <dashlet height="300px" colSpan="3" action="custom:report-dish-count-stats"/>
        <dashlet height="300px" colSpan="3" action="custom:report-dish-count-half-stats"/>
        <dashlet height="350px" colSpan="12" action="custom:report-table-lunch-for-users"/>
        <dashlet height="800px" colSpan="12" action="form:pbp.lunch-form-view"/>

    </dashboard>

<!-- таблица показывающая всех партнеров сделавших заказ-->
    <custom name="report-table-lunch-for-users" title="Users information" css="report-box">
        <field name="fullName" title="Name"/>
        <field name="dishName" title="Dish" type="string" />
        <field name="portion" title="Portion" type="string"/>
        <field name="dateCreate" title="Date of create" type="date"/>
        <field name="partnerComment" title="Comment" type="string"/>

        <dataset type="jpql">
            <![CDATA[
        SELECT u.fullName AS fullName,
               d.name AS dishName,
               l.portion AS portion,
               l.dateCreate AS dateCreate,
               l.partnerComment AS partnerComment
        FROM User u
        LEFT JOIN Lunch l ON u.id = l.partnerName.id
        LEFT JOIN l.dishName d
        WHERE l.dateCreate >= CURRENT_DATE OR l.dateCreate IS NULL
        ORDER BY u.fullName
        ]]>
        </dataset>

        <template><![CDATA[
    <report-table columns='fullName,dishName,portion,dateCreate,partnerComment'/>
    ]]></template>
    </custom>

<!--    report-box-->

    <custom name="report-user-lunch-stats" title="" css="report-box">

        <dataset type="rpc"><![CDATA[com.axelor.apps.pbproject.web.LunchController:reportLunch]]></dataset>
        <template><![CDATA[
        <div class="report-data">
            <h1>{{first.total}}</h1>
            <small>Total users</small>
            <div class="report-tags" style="display: flex; align-items: center;">
                <i class="fa fa-coffee" style="margin-right: 5px;"></i>
                <span class="label label-info">Total users</span>
            </div>
            <h2 style="color: green;">{{first.ordered}}</h2>
            <small>Users who ordered lunch</small>
            <div class="report-tags" style="display: flex; align-items: center;">
            </div>
            <h2 style="color: red;">{{first.notOrdered}}</h2>
            <small>Users who did not order lunch</small>
            <div class="report-tags" style="display: flex; align-items: center;">
            </div>
        </div>
    ]]></template>
    </custom>

    <custom name="report-user-portion-stats" title="" css="report-box">
        <dataset type="rpc"><![CDATA[com.axelor.apps.pbproject.web.LunchController:reportPortion]]></dataset>
        <template><![CDATA[
        <div class="report-data">
            <h1>{{first.onePortionCount}}</h1>
            <small>Portions of 1</small>

            <div class="report-tags" style="display: flex; align-items: center;">
                <i class="fa fa-coffee" style="margin-right: 5px;"></i>
                <span class="label label-info">Portions count</span>
            </div>

            <h2>{{first.oneAndHalfPortionCount}}</h2>
            <small>Portions of 1.5</small>

        </div>
    ]]></template>
    </custom>

    <custom name="report-dish-count-stats" title="" css="report-box">
        <dataset type="rpc"><![CDATA[com.axelor.apps.pbproject.web.LunchController:reportDishCountForPortion]]></dataset>
        <template><![CDATA[
        <div class="report-data">
            <h1>{{first.firstDishCount}}</h1>
            <small>{{first.firstDish}}</small>

            <div class="report-tags" style="display: flex; align-items: center;">
                <i class="fa fa-coffee" style="margin-right: 5px;"></i>
                <span class="label label-info">Portion - 1</span>
            </div>
            <h1>{{first.secondDishCount}}</h1>
            <small>{{first.secondDish}}</small>

                 <h1>{{first.thirdDishCount}}</h1>
            <small>{{first.thirdDish}}</small>


        </div>
    ]]></template>
    </custom>

    <custom name="report-dish-count-half-stats" title="" css="report-box">
        <dataset type="rpc"><![CDATA[com.axelor.apps.pbproject.web.LunchController:reportDishCountForHalf]]></dataset>
        <template><![CDATA[
        <div class="report-data">
            <h1>{{first.firstDishCount}}</h1>
            <small>{{first.firstDish}}</small>

            <div class="report-tags" style="display: flex; align-items: center;">
                <i class="fa fa-coffee" style="margin-right: 5px;"></i>
                <span class="label label-info">Portion - 1.5</span>
            </div>
            <h1>{{first.secondDishCount}}</h1>
            <small>{{first.secondDish}}</small>

                 <h1>{{first.thirdDishCount}}</h1>
            <small>{{first.thirdDish}}</small>


        </div>
    ]]></template>
    </custom>



    <action-attrs name="pbp.update-field-isShow-true">
        <attribute for="isOrderLunch" name="value" expr="true"/>
    </action-attrs>


    <action-attrs name="pbp.update-user-and-date-on-partnerName-for-lunch">
        <attribute name="value" expr="eval: __user__" for="partnerName"/>
        <attribute name="value" expr="eval: __time__" for="dateCreate"/>
    </action-attrs>

    <action-method name="pbp.searchDishOnDuckDuckGo">
        <call class="com.axelor.apps.pbproject.web.LunchController" method="searchDishOnDuckDuckGo"/>
    </action-method>

</object-views>