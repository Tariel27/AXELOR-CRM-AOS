<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.1.xsd">

    <form name="pbp.project-task-form" title="Task" model="com.axelor.apps.project.db.ProjectTask" width="large"
          onLoad="action-business-project-project-task-group-on-load"
          onNew="action-business-project-project-task-group-on-new,pbp.auto-set-assigned-by-action.method">
        <toolbar>
            <button name="grabEventBtn" help="Take charge" icon="fa-suitcase"
                    onClick="action-project-task-record-assigned-yourself,save"/>
            <button name="doneBtn" showIf="project.isShowStatus" icon="fa-check"
                    onClick="action-project-task-validate-finish-status,action-project-task-record-change-status,save"/>
        </toolbar>
        <menubar>
            <menu if="__config__.app.getApp('project')?.resourceManagement" name="projectTaskMenu" title="Tools">
                <item name="bookResourceItem" title="Book resource" action="save,action-project-task-book-resource"/>
            </menu>
        </menubar>
        <panel showIf="nextProjectTask">
            <field name="doApplyToAllNextTasks" colSpan="12" widget="InlineCheckbox"/>
        </panel>
        <panel name="mainPanel" colSpan="12">
            <panel name="statusPanel" colSpan="6" stacked="true">
                <field name="status" onChange="update-progress-on-status-change,save" showTitle="false" showIf="project.isShowStatus" widget="NavSelect"
                       x-order="sequence"/>
                <field name="typeSelect" hidden="true"/>
            </panel>
            <panel name="viewerTagsPanel" colSpan="4">
                <field if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                       name="$viewerTags" showTitle="false" hidden="true" readonly="true"
                       showIf="typeSelect == 'ticket' &amp;&amp; $readonly()" colSpan="12">
                    <viewer><![CDATA[

               <>
                   <Box d="flex" justifyContent="flex-end" gap="4" alignItems="center">
                       {assignment == 1 && <Badge bg="danger">{_t('Task assigned to the client')}</Badge>}
                       {assignment == 2 && !$provider && <Badge bg="success">{_t('Task assigned to the provider')}</Badge>}
                       {assignment == 2 && $provider && <Badge bg="success">{_t('Task assigned to')} {$provider}</Badge>}
                       {((!isOrderAccepted && invoicingType == 2 && exTaxTotal != 0) || (!isOrderAccepted && invoicingType == 1)) && <Badge bg="danger">{_t('Order Proposed')}</Badge>}
                       {isOrderAccepted && <Badge bg="success">{_t('Order Accepted')}</Badge>}
                   </Box>
               </>

      ]]></viewer>
                </field>
            </panel>
            <button name="timeSpentBtn" title="Log time" hidden="true" colSpan="2"
                    onClick="save,action-project-task-validate-check-employee,action-project-task-view-time-spent"/>
            <field name="project.isShowTimeSpent" hidden="true"/>
            <field name="$provider" hidden="true" type="string"/>
            <panel name="projectDetailsPanel" colSpan="12">
                <panel name="detailsPanel" colSpan="8">
                    <field name="fullName" showTitle="false" colSpan="12">
                        <viewer depends="name">
                            <![CDATA[
                                <>
                                    <h3>
                                        <span>{name}</span>
                                    </h3>
                                </>
                            ]]>
                        </viewer>
                        <editor>
                            <field name="name" title="Subject" colSpan="12" css="label-bold bold large"
                                   required="true"/>
                        </editor>
                    </field>
                    <field name="description" colSpan="12" widget="html"/>
                    <field if="__config__.app.getApp('project')?.isEnablePerProjectTaskSequence" name="ticketNumber"/>
                    <field name="project" colSpan="12" onChange="action-project-task-group-project-onchange"
                           domain="self.projectStatus.isCompleted = false" required="true"/>
                    <field name="assignedTo" readonlyIf="project == null" colSpan="6" canNew="false" canView="false"
                           canEdit="false" onChange="action-project-task-group-assigned-to-on-change,pbp.auto-set-assigned-by-action.method"
                           onSelect="action-project-task-attrs-project-assigned-to-configurations" required="true"
                           form-view="user-form" grid-view="user-grid"/>

                    <field name="assignedBy" colSpan="6" form-view="user-form" grid-view="user-grid"/>

                    <field name="parentTask" readonlyIf="project == null" colSpan="12"
                           onChange="action-project-task-record-get-parent-timeunit"
                           onSelect="action-project-task-attrs-project-parent-task-configurations"/>
                    <field name="frameworkCustomerContract" hidden="true"
                           showIf="project.allowToGetPricesFromFrameworkContract"
                           onChange="action-project-task-group-set-price-from-contract"
                           onSelect="action-project-task-method-set-customer-contract-domain"/>
                    <field name="frameworkSupplierContract" hidden="true"
                           showIf="project.allowToGetPricesFromFrameworkContract"
                           onChange="action-project-task-group-set-price-from-contract"
                           onSelect="action-project-task-method-set-supplier-contract-domain"/>
                    <field name="saleOrderLine" readonly="true" showIf="saleOrderLine" form-view="sale-order-line-form"
                           grid-view="sale-order-line-grid"/>
                    <field name="project.allowToGetPricesFromFrameworkContract" hidden="true"/>
                    <field if="__config__.app.getApp('base')?.enableSiteManagementForProject" name="site"
                           onSelect="action-project-task-attrs-set-site-domain" form-view="site-form"
                           grid-view="site-grid"/>
                    <field if="__config__.app.isApp('business-project')" name="customerReferral" hidden="true"
                           showIf="typeSelect == 'ticket'"
                           onSelect="action-project-task-attrs-customer-referral-domain"/>
                    <field if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                           name="isPrivate" hidden="true" showIf="typeSelect == 'ticket'" colSpan="6"/>
                    <field if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                           name="isOrderAccepted" hidden="true" showIf="typeSelect == 'ticket'" colSpan="3"/>
                    <field if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                           name="isOrderProposed" hidden="true" colSpan="3"/>
                </panel>
                <panel name="actionPanel" colSpan="4">
                    <button if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                            name="acceptOrderBtn" title="Accept Order" hidden="true"
                            hideIf="invoicingType != 1  || isOrderAccepted || typeSelect != 'ticket'" colSpan="12"
                            onClick="action-project-task-attrs-onclick-order-accepted,save"/>
                    <button if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                            name="assigningProviderBtn" title="Assigning to the provider" hidden="true"
                            showIf="assignment == 1 &amp;&amp; typeSelect == 'ticket'" colSpan="12"
                            onClick="action-project-task-attrs-assginment-provider,save"/>
                    <button if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                            name="assigningCustomerBtn" title="Assigning to the customer" hidden="true"
                            showIf="assignment == 2 &amp;&amp; typeSelect == 'ticket'" colSpan="12"
                            onClick="action-project-task-attrs-assginment-customer,save"/>
                </panel>
            </panel>
            <panel name="characteristicsPanel" title="Characteristics" colSpan="12">
                <panel name="categoryPanel" showIf="project.isShowTaskCategory" colSpan="4">
                    <field name="projectTaskCategory" colSpan="12"
                           onChange="action-project-task-group-project-category-onchange"
                           onSelect="action-project-task-attrs-project-task-category-configurations"
                           help="This field indicates the task type or category, which helps categorize tasks in the project."/>
                </panel>
                <panel name="sectionPanel" showIf="project.isShowSection" colSpan="4">
                    <field name="projectTaskSection" colSpan="12" form-view="project-task-section-form"
                           grid-view="project-task-section-grid"
                           help="This field indicates the section or stage of the project to which the issue relates."/>
                </panel>
                <panel name="priorityPanel" showIf="project.isShowPriority" colSpan="4">
                    <field name="priority" colSpan="12" canView="false"
                           onSelect="action-project-task-atts-priority-on-select" requiredIf="project.isShowPriority"/>
                </panel>
                <field if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                       name="targetVersion" colSpan="4" domain=":project member of self.projectSet"
                       form-view="project-version-form" grid-view="project-version-grid"/>
                <field if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                       name="assignment" hidden="true" showIf="typeSelect == 'ticket'" colSpan="4"/>
                <!--Даты с использованием времени-->
                <field name="startDateTime" colSpan="4" onChange="update-date-fields"/>
                <field name="endDateTime" colSpan="4" onChange="update-date-fields"/>
                <field name="deadlineDateTime" colSpan="4" onChange="update-date-fields"/>

                <!--Скрытые даты-->
                <field name="taskDate" colSpan="4"
                       onChange="action-project-task-attrs-set-task-duration,action-project-task-record-set-date-or-frequency-changed"
                       required="true" hidden="true"/>
                <field name="taskEndDate" colSpan="4" onChange="action-project-task-attrs-set-task-duration"
                       hidden="true"/>
                <field name="taskDeadline" title="Task deadline" colSpan="4" hidden="true"/>

                <field name="projectTaskTagSet" colSpan="4" widget="TagSelect" form-view="project-task-tag-form"
                       grid-view="project-task-tag-grid" x-color-field="colorSelect"/>
                <field name="progress" showIf="project.isShowProgress &amp;&amp; !$readonly()" colSpan="4"
                       onChange="action-project-task-group-progress-onchange" min="0"/>


                <field name="spentTime" colSpan="2" onChange="action-readable-time-convert"/>
                <field name="readableSpentTime" colSpan="2" widget="String"/>


                <spacer showIf="project.isShowProgress &amp;&amp; !$readonly()" colSpan="8"/>
                <field name="progress" showIf="project.isShowProgress &amp;&amp; $readonly()" colSpan="4"
                       widget="SelectProgress"/>
                <spacer showIf="project.isShowProgress &amp;&amp; $readonly()" colSpan="8"/>
                <field name="invoicingProgress" readonly="true" showIf="invoicingType == 4" colSpan="6"/>
                <field if="__config__.app.isApp('business-project')" name="timeUnit"
                       readonlyIf="saleOrderLine || parentTask" colSpan="4"
                       onSelect="action-project-task-attrs-set-time-unit-domain"/>
                <field name="project.isShowProgress" hidden="true"/>
                <field name="project.isShowSection" hidden="true"/>
                <field name="project.isShowStatus" hidden="true"/>
                <field name="project.isShowPriority" hidden="true"/>
                <field name="project.isShowTaskCategory" hidden="true"/>
            </panel>
        </panel>
        <panel-tabs name="mainPanelTab">
            <panel if="__config__.app.isApp('business-project')" name="timeFollowUpPanel" title="Time follow-up"
                   showIf="timeUnit">
                <field name="soldTime" hidden="true" showIf="!parentTask" readonlyIf="saleOrderLine" colSpan="3"
                       onChange="action-project-task-record-fill-updated-time"/>
                <field name="updatedTime" hidden="true" showIf="!parentTask" colSpan="3"/>
                <spacer/>
                <field name="plannedTime" readonly="true" colSpan="3"/>
                <field name="spentTime" readonly="true" colSpan="3"/>
                <panel name="reportingPanel" showIf="!parentTask" colSpan="12">
                    <panel-dashlet showTitle="false" colSpan="3" height="125"
                                   action="action-project-task-view-percentage-progress-custom"/>
                    <panel-dashlet showTitle="false" colSpan="3" height="125"
                                   action="action-project-task-view-percentage-consumption-custom"/>
                    <panel-dashlet showTitle="false" colSpan="3" height="125"
                                   action="action-project-task-view-remaining-to-do-custom"/>
                </panel>
            </panel>
            <panel if="__config__.app.isApp('business-support')" if-module="axelor-business-support"
                   name="internalDescriptionPanel" title="Internal Description">
                <field name="internalDescription" colSpan="12" widget="html"/>
            </panel>
            <panel if="__config__.app.isApp('employee')" if-module="axelor-human-resource" name="planningPanel"
                   title="Planning" showIf="project.isShowPlanning">
                <field name="budgetedTime" colSpan="4">
                    <viewer><![CDATA[
               	<><span>{$fmt('budgetedTime')} </span><span>{_t('hours')}</span></>
   			]]></viewer>
                </field>
                <spacer name="budgetedTimeSpacer" colSpan="4"/>
                <panel-dashlet name="projectPlanningTimePanel" title="Planned Time Planning" colSpan="12"
                               action="action-project-task-dashlet-project-planning-time" canSearch="true"
                               x-show-bars="false"/>
                <field name="plannedProgress" hidden="true" colSpan="12" widget="progress"/>
                <field name="project.isShowPlanning" hidden="true"/>
            </panel>
            <panel name="treeViewPanel" title="Tree view" showIf="id" colSpan="12">
                <panel-dashlet name="taskTreePanel" title="Task Tree" colSpan="12" action="action-view-show-task-tree"/>
                <panel-related name="finishToStartSetPanel" colSpan="12" field="finishToStartSet">
                    <field name="name"/>
                </panel-related>
            </panel>
            <panel if="__config__.app.isApp('business-project')" if-module="axelor-business-project"
                   name="purchasePanel" title="Purchase" colSpan="12">
                <button name="generatePurchaseOrderBtn" title="Generate Purchase Order"
                        onClick="action-project-task-method-generate-purchase-order"/>
                <field name="purchaseOrderList" colSpan="12" canNew="false"/>
                <field name="purchaseOrderLineList" colSpan="12" canNew="false"/>
            </panel>
            <panel if="__config__.app.isApp('business-project')" if-module="axelor-business-project"
                   name="financialDataPanel" title="Financial Data" colSpan="12">
                <panel name="contentPanel" title="Content" colSpan="12" canCollapse="true">
                    <field name="product" readonlyIf="saleOrderLine" colSpan="3" canEdit="false"
                           onChange="action-business-project-project-task-group-product-onchange"
                           onSelect="action-project-task-attrs-set-product-domain" form-view="product-form"
                           grid-view="product-grid"/>
                    <field name="quantity" readonlyIf="saleOrderLine" colSpan="3"
                           onChange="action-project-task-group-qty-onchange"/>
                    <field name="unitPrice" readonlyIf="saleOrderLine || frameworkCustomerContract" colSpan="3"
                           onChange="action-project-task-group-unit-price-onchange"/>
                    <field name="unitCost" readonlyIf="saleOrderLine || frameworkSupplierContract" colSpan="3"/>
                    <field name="invoicingUnit" readonlyIf="saleOrderLine" colSpan="3" canEdit="false"
                           domain="self.unitTypeSelect=3" form-view="unit-form" grid-view="unit-grid"/>
                    <field name="currency" readonlyIf="saleOrderLine" colSpan="3" canEdit="false"
                           form-view="currency-form" grid-view="currency-grid"/>
                    <field name="exTaxTotal" readonly="true" colSpan="3"/>
                    <field name="totalCosts" colSpan="3"/>
                    <field name="invoicingType" readonlyIf="invoiceLineSet &amp;&amp; invoiceLineSet.length > 0"
                           colSpan="3" onChange="action-project-task-attrs-onchange-invoice-type"/>
                    <field if="__config__.app.getApp('business-project').automaticInvoicing" name="toInvoice"
                           readonly="true" colSpan="2"/>
                    <field if="!__config__.app.getApp('business-project').automaticInvoicing" name="toInvoice"
                           readonlyIf="invoiced" colSpan="2"/>
                    <field name="isPaid" showIf="project.invoicingSequenceSelect == 1" colSpan="2"/>
                    <field name="isTaskRefused" colSpan="2"/>
                    <field name="invoiced" hidden="true" showIf="id &amp;&amp; !($readonly())" colSpan="1"/>
                    <field name="invoiced" showTitle="false" hidden="true" showIf="id &amp;&amp; $readonly()"
                           colSpan="1">
                        <viewer><![CDATA[
                 <>
                 	<Box d="flex" justifyContent="flex-end">
                 		<Badge bg={invoiced ? "success" : "danger"}>{invoiced ? _t('Invoiced') : _t('Not invoiced')}</Badge>
                 	</Box>
                 </>
	]]></viewer>
                    </field>
                    <panel if="__config__.app.isApp('business-project')" if-module="axelor-business-project"
                           name="discountPanel" readonly="true"
                           hideIf="discountTypeSelect == 3 || discountTypeSelect == 0" colSpan="12">
                        <field name="discountTypeSelect" colSpan="3"
                               onChange="action-sale-order-line-attrs-discountamount-title"/>
                        <field name="discountAmount" colSpan="3"/>
                        <field name="priceDiscounted" colSpan="3"/>
                    </panel>
                    <field if="__config__.app.isApp('business-project')" if-module="axelor-business-project"
                           name="project.invoicingSequenceSelect" hidden="true"/>
                    <field name="invoiceLineSet" readonly="true" showIf="invoiceLineSet" colSpan="12"
                           form-view="invoice-line-form" grid-view="invoice-line-grid"/>
                </panel>
                <field if="__config__.app.getApp('project')?.isEnableSignature" name="metaFile" width="120"
                       widget="Image"/>
                <panel name="soldPanel" title="ProjectTask.Sold" showIf="!parentTask" colSpan="12">
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-turnover-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-initial-costs-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-initial-margin-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-initial-markup-custom"/>
                    <field name="turnover" hidden="true"/>
                    <field name="initialCosts" hidden="true"/>
                    <field name="initialMargin" hidden="true"/>
                    <field name="initialMarkup" hidden="true"/>
                </panel>
                <panel name="forecastPanel" title="ProjectTask.Forecast" colSpan="12">
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-forecast-costs-custom"/>
                    <panel-dashlet hidden="true" showIf="!parentTask" colSpan="3" height="125"
                                   action="action-project-task-view-forecast-margin-custom"/>
                    <panel-dashlet hidden="true" showIf="!parentTask" colSpan="3" height="125"
                                   action="action-project-task-view-forecast-markup-custom"/>
                    <field name="forecastCosts" hidden="true"/>
                    <field name="forecastMargin" hidden="true"/>
                    <field name="forecastMarkup" hidden="true"/>
                </panel>
                <panel name="realPanel" title="ProjectTask.Real" hidden="true" showIf="!parentTask" colSpan="12">
                    <panel-dashlet showIf="timeUnit" colSpan="3" height="125"
                                   action="action-project-task-view-real-turnover-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-real-costs-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-real-margin-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-real-markup-custom"/>
                    <field name="realTurnover" hidden="true"/>
                    <field name="realCosts" hidden="true"/>
                    <field name="realMargin" hidden="true"/>
                    <field name="realMarkup" hidden="true"/>
                </panel>
                <panel name="realCostPanel" title="" hidden="true" showIf="parentTask" colSpan="12">
                    <panel-dashlet title="Real costs" colSpan="3" height="125"
                                   action="action-project-task-view-real-costs-custom"/>
                    <field name="realCosts" hidden="true"/>
                </panel>
                <panel name="landingPanel" title="ProjectTask.Landing" colSpan="12">
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-landing-costs-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-landing-margin-custom"/>
                    <panel-dashlet colSpan="3" height="125" action="action-project-task-view-landing-markup-custom"/>
                    <field name="landingCosts" hidden="true"/>
                    <field name="landingMargin" hidden="true"/>
                    <field name="landingMarkup" hidden="true"/>
                </panel>
            </panel>
            <panel name="frequencyPanel" title="Frequency" showIf="project.isShowFrequency">
                <field name="frequency" canNew="true"
                       onChange="action-project-task-record-set-date-or-frequency-changed" domain="1 &lt;> 1"
                       form-view="frequency-form" grid-view="frequency-grid"/>
                <field name="nextProjectTask" hidden="true" showIf="nextProjectTask"/>
                <field name="isFirst" hidden="true"/>
                <field name="doUpdateNextTasks" hidden="true"/>
                <field name="hasDateOrFrequencyChanged" hidden="true"/>
                <field name="project.isShowFrequency" hidden="true"/>
            </panel>
            <panel if="__config__.app.isApp('timesheet')" if-module="axelor-human-resource" name="timeSpentPanel"
                   title="Time Spent" showIf="project.isShowTimeSpent">
                <panel-dashlet if="__config__.app.getApp('timesheet')?.needValidation"
                               name="validatedTimesheetLinesPanel" title="Validated Timesheet lines" colSpan="12"
                               action="action-project-task-dashlet-validated-timesheet-lines" canSearch="true"/>
                <panel-dashlet if="__config__.app.getApp('timesheet')?.needValidation" name="waitingTimesheetLinesPanel"
                               title="Waiting Timesheet lines" colSpan="12"
                               action="action-project-task-dashlet-waiting-timesheet-lines" canSearch="true"/>
                <panel-dashlet if="!__config__.app.getApp('timesheet')?.needValidation" name="allTimesheetLinesPanel"
                               title="TimesheetLine.timeSpent" colSpan="12"
                               action="action-project-task-dashlet-all-timesheet-lines" canSearch="true"/>
            </panel>
            <panel if="__config__.app.isApp('helpdesk')" if-module="axelor-helpdesk" name="timerPanel" title="Timer"
                   hidden="true" showIf="id">
                <panel name="actionsPanel" title="Actions">
                    <button name="startTimerBtn" title="Start" hidden="true" colSpan="12" icon="fa-play"
                            onClick="action-project-task-method-start-timer"/>
                    <button name="stopTimerBtn" title="Stop" hidden="true" colSpan="12" icon="fa-pause"
                            onClick="action-project-task-method-stop-timer"/>
                    <button name="cancelTimerBtn" title="Cancel" hidden="true" colSpan="12" icon="fa-times-circle"
                            onClick="action-project-task-method-cancel-timer"/>
                </panel>
                <panel name="durationPanel">
                    <field name="$_totalTimerDuration" title="Total duration (Hours)" readonly="true" colSpan="12"
                           type="decimal"/>
                </panel>
            </panel>
        </panel-tabs>
        <panel name="attrsPanel">
            <field name="attrs" colSpan="12"/>
        </panel>
        <panel-mail name="mailPanel">
            <mail-messages/>
            <mail-followers/>
        </panel-mail>
    </form>

    <!--добавил action-->
    <action-view name="action-view-show-project-task-tree2" title="Project Task Tree"
                 model="com.axelor.apps.project.db.ProjectTask">
        <view type="tree" name="project-project-task-tree2"/>
        <view type="form" name="project-task-form"/>
        <domain>self.project.id = :_id AND self.parentTask = null</domain>
        <context name="_id" expr="eval: id"/>
    </action-view>

    <!--    добавил view-->
    <tree id="project-project-task-tree2" name="project-project-task-tree2" title="Task">
        <column name="name" type="string"/>
        <column name="taskDate" type="date"/>
        <!--        <column name="initial" type="decimal"/>-->
        <!--        <column name="forecast" type="decimal"/>-->
        <!--        <column name="real" type="decimal"/>-->
        <!--        <column name="landing" type="decimal"/>-->
        <column name="assignedTo" type="reference"/>
        <column name="createSubtaskBtn" type="button"/>
        <column name="generatePurchaseOrderBtn" type="button"/>
        <column name="deleteTaskBtn" type="button"/>
        <column name="openTaskBtn" type="button"/>
        <node model="com.axelor.apps.project.db.ProjectTask"
              onClick="action-project-task-view-task" domain="self.project.id = :_id" orderBy="taskDate">
            <field name="name" as="name"/>
            <field name="taskDate" as="taskDate"/>
            <field name="initialMarkup" as="initial"/>
            <field name="forecastMarkup" as="forecast"/>
            <field name="realMarkup" as="real"/>
            <field name="landingMarkup" as="landing"/>
            <field name="assignedTo" as="assignedTo"/>
            <field name="progress" as="progress"/>
            <button name="createSubtaskBtn" icon="fa-plus"
                    onClick="save, action-project-view-add-subtask"/>
            <button name="generatePurchaseOrderBtn" icon="fa-shopping-cart"
                    onClick="save, action-project-task-method-generate-purchase-order"/>
            <button name="deleteTaskBtn" icon="fa-times-circle"
                    onClick="action-project-task-validate-delete-team-task-confirmation,action-project-task-method-delete-project-task"/>
            <button name="openTaskBtn" icon="fa-external-link"
                    onClick="action-project-task-open-task"/>
        </node>
        <node model="com.axelor.apps.project.db.ProjectTask" parent="parentTask"
              onClick="action-project-task-view-task" draggable="true" orderBy="taskDate">
            <field name="name" as="name"/>
            <field name="taskDate" as="taskDate"/>
            <field name="assignedTo" as="assignedTo"/>
            <field name="progress" as="progress"/>
            <button name="createSubtaskBtn" icon="fa-plus"
                    onClick="save, action-project-view-add-subtask"/>
            <button name="generatePurchaseOrderBtn" icon="fa-shopping-cart"
                    onClick="save, action-project-task-method-generate-purchase-order"/>
            <button name="deleteTaskBtn" icon="fa-times-circle"
                    onClick="action-project-task-validate-delete-team-task-confirmation,action-project-task-method-delete-project-task"/>
            <button name="openTaskBtn" icon="fa-external-link"
                    onClick="action-project-task-open-task"/>
        </node>
    </tree>
    <!--Канбан, где тикеты работают с Date-Time, показывают также время начала-->
    <kanban name="pbp.project-task-kanban" title="Tasks" model="com.axelor.apps.project.db.ProjectTask"
            columnBy="status" sequenceBy="sequence" draggable="true" limit="30">
        <field name="name"/>
        <field name="project"/>
        <field name="assignedTo"/>
        <field name="priority.name"/>
        <field name="priority.technicalTypeSelect"/>
        <field name="progress"/>
        <field name="project.isShowProgress"/>
        <field name="startDateTime"/>
        <field name="deadlineDateTime"/>
        <template><![CDATA[
<>
	<strong>{name}</strong>
        <Box style={{ fontWeight: "bold", fontSize: "1.1rem", color: "#1890ff", marginTop: "5px" }}>
    		{project.fullName}
		</Box>
	<Box d="flex" justifyContent="space-between">
		<Box>
			<Icon icon="calendar" fontSize="15px"/>
		        {!deadlineDateTime && <span> {_t('Not specified')} </span>}
		        {deadlineDateTime && <span>{_t('Deadline')}: {$moment(deadlineDateTime).format('YYYY-MM-DD HH:mm')}</span>}
		</Box>
		<Box>
			{priority.technicalTypeSelect == 1 && <Badge bg="success">{priority.name}</Badge>}
			{priority.technicalTypeSelect == 2 && <Badge bg="info">{priority.name}</Badge>}
			{priority.technicalTypeSelect == 3 && <Badge bg="warning">{priority.name}</Badge>}
			{priority.technicalTypeSelect == 4 && <Badge bg="danger">{priority.name}</Badge>}
		</Box>
	</Box>
	{project.isShowProgress &&
		<Box mt={1}>
			{progress == 0 ? <span>{progress}%</span> : <LinearProgress value={progress} striped animated/>}
		</Box>
	}
    <Box d="grid" gridTemplateColumns="auto auto" style={{ fontSize: "0.85rem", color: "grey" }} mt={2}>
        <Box d="flex" g={2}>
        	<Icon icon="clock" fontSize="15px"/>
             {startDateTime ? <span>{_t('Task start')}: {$moment(startDateTime).format('YYYY-MM-DD HH:mm')}</span> : <span>{_t('Not started')}</span>}
        </Box>
        <Box d="flex" justifyContent="flex-end">
        	{assignedTo && <Image src={$image('assignedTo', 'image')} style={{ width: "1.5rem", height: "1.5rem", borderRadius: "100%" }}></Image>}
        </Box>
    </Box>
</>
 ]]></template>
    </kanban>


    <!--Экшн который автоподставляет даты для системы xelor, hidden=true-->
    <action-attrs name="update-date-fields">
        <attribute for="taskDate" name="value"
                   expr="eval: __this__.startDateTime != null ? __this__.startDateTime.toLocalDate() : null"/>
        <attribute for="taskEndDate" name="value"
                   expr="eval: __this__.endDateTime != null ? __this__.endDateTime.toLocalDate() : null"/>
        <attribute for="taskDeadline" name="value"
                   expr="eval: __this__.deadlineDateTime != null ? __this__.deadlineDateTime.toLocalDate() : null"/>
    </action-attrs>

    <!--  Метод который меняет биг децимал на TT:MM  -->
    <action-method name="action-readable-time-convert">
        <call class="com.axelor.apps.pbproject.web.ReadableTimeController" method="convertToReadable"/>
    </action-method>

    <!-- Метод который авто подставляет юзера -->
    <action-method name="pbp.auto-set-assigned-by-action.method">
        <call class="com.axelor.apps.pbproject.web.UserController" method="autoSetAssigner"/>
    </action-method>

    <!--action который меняет progress при сменен статуса задачи-->
    <action-attrs name="update-progress-on-status-change">
        <attribute for="progress" name="value" expr="0" if="status?.name == 'New'"/>
        <attribute for="progress" name="value" expr="40" if="status?.name == 'In progress'"/>
        <attribute for="progress" name="value" expr="70" if="status?.name == 'In testing'"/>
        <attribute for="progress" name="value" expr="100" if="status?.name == 'Done'"/>
        <attribute for="progress" name="value" expr="0" if="status?.name == 'Canceled'"/>
    </action-attrs>

</object-views>
