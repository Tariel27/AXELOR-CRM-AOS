<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.0.xsd">

    <!--  Дашборд страница, где будут дашлеты разные в будущем...  -->
    <dashboard name="pbp.main-pp-dashboard" title="Petaboard">
        <dashlet height="250" width="300" action="pbp.dashlet-card-duty-users"/>
        <dashlet height="250" width="300" action="pbp.list-activity-custom"/>
    </dashboard>


    <!-- Экшены для дашборда -->

    <!-- Экшн для карточек с дежурными -->
    <action-view name="pbp.dashlet-card-duty-users" title="Duty users"
                 model="com.axelor.apps.pbproject.db.Duty">
        <view type="cards" name="pbp.duty-users-cards"/>
        <domain>dateStart = (select max(d.dateStart) from Duty d)</domain>
    </action-view>


    <!-- Экшн для получения custom пользователей онлайн или нет -->

    <action-view name="pbp.list-activity-custom" title="Users activity">
        <view type="custom" name="pbp.users-activity-list-custom"/>
    </action-view>

    <!--  Формы для дашборда  -->

    <!-- Карточка с дежурными -->
    <cards name="pbp.duty-users-cards" title="Duty Users" model="com.axelor.apps.pbproject.db.Duty" orderBy="dateStart">
        <field name="users"/>
        <field name="dateStart"/>
        <field name="dateEnd"/>
        <template><![CDATA[
            <div class="card" style="width: 400px; padding: 10px;">
            <div class="card-content" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <strong>На этой неделе:</strong> {{dateStart}} - {{dateEnd}}<br />
            <strong>Дежурные:</strong> {{users.map(user => user.fullName).join(', ') || 'No duty users'}}
            </div>
            </div>
    ]]></template>
    </cards>

    <custom name="pbp.users-activity-list-custom" title="Users activity">
        <field name="name" type="string"/>
        <field name="lastActiveDateTime" type="datetime"/>
        <dataset type="rpc">
            <![CDATA[com.axelor.apps.pbproject.web.UserActivityController:getListActivityUser]]></dataset>
        <template>
            <![CDATA[
              <>
                  {data && data.length ? (
                    <report-table data='data' columns='name,lastActiveDateTime'></report-table>
                  ) : (
                    <Box style={{ marginTop: "1rem" }}>Активные пользователи не найдены.</Box>
                  )}
              </>
            ]]>
        </template>
    </custom>
</object-views>