<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.0.xsd">

    <!-- Методы для дашбордов -->
    <action-method name="pbp.action-method-for-update-duty-users">
        <call class="com.axelor.apps.pbproject.web.DutyUserController"
              method="updateDutyUsers"/>
    </action-method>

    <!--  Дашборд страница, где будут дашлеты разные в будущем...  -->
    <dashboard name="pbp.main-pp-dashboard" title="Petaboard">
        <dashlet height="250" width="300" action="pbp.dashlet-card-duty-users"/>
        <dashlet height="250" width="300" action="pbp.list-activity-custom"/>
        <dashlet height="250" width="300" action="pbp.manager-news-action-for-main"/>
    </dashboard>


    <!-- Экшены для дашборда -->

    <!-- action для новостей -->
        <action-view name="pbp.news-cards-view" title="News"
                     model="com.axelor.apps.pbproject.db.News">
            <view type="cards" name="pbp.news-users-cards"/>
        </action-view>


    <!-- Экшн для карточек с дежурными -->
    <action-view name="pbp.dashlet-card-duty-users" title="Duty users"
                 model="com.axelor.apps.pbproject.db.Duty">
        <view type="cards" name="pbp.duty-users-cards"/>
        <view type="form" name="pbp.duty-users-form-view"/>
        <domain>dateStart = (select max(d.dateStart) from Duty d)</domain>
    </action-view>


    <!-- Экшн для получения custom пользователей онлайн или нет -->

    <action-view name="pbp.list-activity-custom" title="Users activity">
        <view type="custom" name="pbp.users-activity-list-custom"/>
    </action-view>

    <!--  Формы для дашборда  -->
    <form title="Duty users" name="pbp.duty-users-form-view" model="com.axelor.apps.pbproject.db.Duty">
        <panel>
            <field name="users" colSpan="12"/>
            <field name="dateStart"/>
            <field name="dateEnd"/>
        </panel>
    </form>

    <!-- Карточка с дежурными -->
    <cards name="pbp.duty-users-cards" title="Duty Users" model="com.axelor.apps.pbproject.db.Duty" orderBy="dateStart"
           width="380">
        <field name="users"/>
        <field name="dateStart"/>
        <field name="dateEnd"/>
        <template><![CDATA[
            <div class="card" style="width: 400px; padding: 10px;">
            <div class="card-content" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <strong>На этой неделе:</strong> {{dateStart}} - {{dateEnd}}<br />
            <strong>Дежурные:</strong> {{users.map(user => user.fullName).join(', ') || 'No duty users'}}
            </div>
            </div>
    ]]></template>
    </cards>

    <!--  grid для новостей -->
    <grid title="News" name="pbp.news-grid-view" model="com.axelor.apps.pbproject.db.News">
        <field name="title"/>
        <field name="text"/>
        <field name="dateCreate"/>
        <field name="author"/>
    </grid>
    <!--  form для новостей -->
    <form name="pbp.news-form-view" title="News" model="com.axelor.apps.pbproject.db.News" width="large" onNew="pbp.update-author-and-date-for-news">
        <panel title="General" colSpan="11" itemSpan="12">
            <field name="title" colSpan="12"/>
            <field name="text" widget="html"/>
            <field name="isPublish" widget="boolean-switch"/>
            <field name="dateCreate" hidden="true"/>
            <field name="author" hidden="true"/>
        </panel>
    </form>

    <!-- card для новостей -->
    <cards name="pbp.news-cards-view" title="Manager news" model="com.axelor.apps.pbproject.db.News" width="33%" orderBy="isPublish">
        <field name="title" colSpan="12"/>
        <field name="text"/>
        <field name="isPublish"/>
        <field name="dateCreate"/>
        <field name="author"/>
        <template><![CDATA[
    <div class="card-header" style="background: #ebfcec;
       padding: 1.5em; border-radius: 1em; color: #333333;
       box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.15), inset 0 0 50px rgba(108, 149, 203, 0.3);">
      <strong style="font-size: 2.6em; font-weight: bold;">{{title}}</strong>
      <p style="font-size: 1.4em; margin-top: 1em; opacity: 0.9;">
          {{$raw('text').length > 100 ? $raw('text').substring(0, 100) + '...' : $raw('text')}}
      </p>
      <p style="font-size: 1.1em; margin-top: 1em; color: #555;">
          <strong>Published:</strong>
          <span style="color: {{isPublish ? 'green' : 'red'}};">
              {{isPublish ? '✔' : '✘'}}
          </span>
          <br>
          <strong>Date:</strong> {{$fmt('dateCreate')}}<br>
          <strong>Author:</strong> {{author.fullName}}
      </p>
  </div>
]]></template>
    </cards>


    <!-- card для новостей Main-->
    <cards name="pbp.news-cards-view-for-main" title="Manager news" model="com.axelor.apps.pbproject.db.News"
           width="100%" orderBy="dateCreate" canEdit="false" canDelete="false" >
        <field name="title" colSpan="12"/>
        <field name="text"/>
        <field name="dateCreate"/>
        <field name="author"/>
        <template><![CDATA[
    <div class="card-header" style="background: #f9f9f9;
       padding: 1.5em; border-radius: 1em; color: #333333;
       box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.15), inset 0 0 50px rgba(108, 149, 203, 0.3);">
      <strong style="font-size: 2.6em; font-weight: bold;">{{title}}</strong>
      <p style="font-size: 1.4em; margin-top: 1em; opacity: 0.9;">
          {{$raw('text').length > 100 ? $raw('text').substring(0, 100) + '...' : $raw('text')}}
      </p>
      <p style="font-size: 1.1em; margin-top: 1em; color: #555;">


          <br>
          <strong>Date:</strong> {{$fmt('dateCreate')}}<br>
          <strong>Author:</strong> {{author.fullName}}
      </p>
  </div>

    ]]></template>
    </cards>


    <custom name="pbp.users-activity-list-custom" title="Users activity">
        <field name="name" type="string"/>
        <field name="lastActiveDateTime" type="datetime"/>
        <dataset type="rpc">
            <![CDATA[com.axelor.apps.pbproject.web.UserActivityController:getListActivityUser]]>
        </dataset>
        <template>
            <![CDATA[
            <>
                {data && data.length ? (
                    <Table>
                        <thead>
                            <tr>
                                <th style={{ textAlign: "left" }}>Полное имя</th>
                                <th style={{ textAlign: "left" }}>Активность</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map(user => (
                                <tr key={user.name}>
                                    <td>
                                        <Box as="span">{user.name || "Неизвестный пользователь"}</Box>
                                    </td>
                                    <td>
                                        <Box as="span">
                                            {user.lastActiveDateTime
                                                ? new Date(user.lastActiveDateTime).toLocaleString('ru-RU', {
                                                    year: 'numeric',
                                                    month: 'numeric',
                                                    day: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit',
                                                    hour12: false
                                                }).replace(',', '') // Убираем запятую
                                                : "offline"}
                                        </Box>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </Table>
                ) : (
                    <Box style={{ marginTop: "1rem" }}>Активные пользователи не найдены.</Box>
                )}
            </>
        ]]>
        </template>
    </custom>

    <action-attrs name="pbp.update-author-and-date-for-news">
        <attribute name="value" expr="eval: __user__" for="author"/>
        <attribute name="value" expr="eval: __time__" for="dateCreate"/>
    </action-attrs>
    <action-view name="pbp.manager-news-action-for-main" title="Manager news" model="com.axelor.apps.pbproject.db.News">
        <view type="cards" name="pbp.news-cards-view-for-main"/>
        <domain>self.isPublish = true</domain>

    </action-view>
</object-views>